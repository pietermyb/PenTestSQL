using System.Linq;
using Microsoft.AspNetCore.Mvc;
using PenTestSQL.Data;
using Microsoft.EntityFrameworkCore;
using System;
using PenTestSQL.Models;
using System.Text.RegularExpressions;

namespace PenTestSQL.Controllers
{
    public class MakeController : Controller
    {
        private ApplicationDbContext _appDdContext;

        public MakeController(ApplicationDbContext appDdContext)
        {
            _appDdContext = appDdContext;
        }

        public ActionResult Index(int id, string orderBy = "Id")
        {
            var make = _appDdContext.Makes.Single(m => m.MakeId == id);
            var query = "SELECT * FROM MotorBikes WHERE MakeID = " + id + " ORDER BY " + orderBy;
            var motorBikes = _appDdContext.MotorBikes.FromSql(query);

            ViewBag.Make = make.Name;
            ViewBag.MakeId = make.MakeId;

            Console.WriteLine(query);

            var allMakes = _appDdContext.Makes.AsEnumerable();
            var makeVM = new MakesViewModel
            {
                MotorBikesForMake = motorBikes,
                AllMakes = allMakes
            };

            if (motorBikes.Count() > 0 && orderBy.Length > 10)
            {
                Console.WriteLine("UNION INJECTION: {0}", query);
            }

            return View(makeVM);
        }
    }
}
