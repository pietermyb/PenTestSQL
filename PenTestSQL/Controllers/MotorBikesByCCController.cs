using System.Linq;
using Microsoft.AspNetCore.Mvc;
using PenTestSQL.Data;
using Microsoft.EntityFrameworkCore;
using PenTestSQL.Models;
using System;
using System.Text.RegularExpressions;
using System.Collections.Generic;

namespace PenTestSQL.Controllers
{
    public class MotorBikesByCCController : Controller
    {
        private ApplicationDbContext _appDdContext;

        public MotorBikesByCCController(ApplicationDbContext appDdContext)
        {
            _appDdContext = appDdContext;
        }
        
        public IActionResult Index()
        {
            var motorBikes = _appDdContext.MotorBikes
                              .Select(m => new MotorBikeByCCViewModel
                              {
                                  MotorBikeId = m.Id,
                                  Model = m.Model,
                                  CC = m.CC
                              })
                              .OrderBy(s => s.Model);

            ViewBag.Title = string.Format("Search for Motorbikes by engine layout");

            return View(motorBikes);
        }

        public IActionResult Search(string cc)
        {
            var query = "SELECT Id, Name, Model, CC FROM MotorBikes WHERE CC = '" + cc + "'";

            var motorBikes = _appDdContext.MotorBikes.FromSql(query)
                              .Select(m => new MotorBikeByCCViewModel
                              {
                                  MotorBikeId = m.Id,
                                  Name = m.Name,
                                  Model = m.Model,
                                  CC = m.CC
                              });

            ViewBag.Title = string.Format("Motorbikes with a {0} engine layout", cc);

            if (motorBikes.Count() > 0 && Regex.IsMatch(cc, @"\d"))
            {
                Console.WriteLine("BASIC INJECTION: {0}", query);
            }


            return View(motorBikes);
        }

        public IActionResult SearchOrdered(string cc, string orderBy = "CC")
        {
            var query = "SELECT * FROM MotorBikes WHERE CC = '" + cc + "' ORDER BY '" + orderBy + "'";

            var motorBikes = _appDdContext.MotorBikes.FromSql(query);

            var motorBikeVM = new List<MotorBikeByCCViewModel>();

            foreach (var m in motorBikes.ToList())
            {
                motorBikeVM.Add(new MotorBikeByCCViewModel
                              {
                                  MotorBikeId = m.Id,
                                  Name = m.Name,
                                  Model = m.Model,
                                  CC = m.CC
                              });
            }
           
            ViewBag.Title = string.Format("Motorbikes with a {0} engine layout", cc);

            if(!Regex.IsMatch(cc, @"\d"))
            {
                Console.WriteLine("BASIC INJECTION: {0}", query);
            }
            

            return View(motorBikeVM);
        }
    }
}
